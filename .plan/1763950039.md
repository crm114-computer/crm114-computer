# Hidden User SSH Bootstrap

_Request timestamp: 1763950039_
_Branch: session-1763940000-installer-hidden-user_

## Atomic Work Units
1. ✅ Review research + install.sh to align scope with minimal hidden-user SSH workflow
   - Re-read install.sh plus `docs/research/charm-stack-and-macos-hidden-user.md` and `docs/research/crm114-install-script-plan.md` to constrain this phase to hidden-user provisioning + SSH key bootstrap.
2. ✅ Design Gum-driven installer flow covering hidden user creation and key provisioning only
   - Captured phase-by-phase Gum interactions and shell operations in the new "Gum Installer Flow" section scoped to user + key tasks.
3. ✅ Update plan index and document dependencies/open questions
   - Added summary entry to `.plan/index.md` and recorded required tooling plus blockers in "Dependencies & Open Questions".
4. ✅ Document reinstall detection + guided removal confirmation
   - Added "Reinstall Detection & Cleanup" covering detection of hidden home/libexec/credential artifacts and dual Gum confirmations before destructive cleanup.
5. ✅ Enforce passwordless SSH assumption for crm114 access
   - Plan now assumes ed25519 keypair generation every run, storing public key remotely and never relying on crm114 passwords.
6. ✅ Guarantee fully automated local SSH client setup for `ssh crm114@localhost`
   - Script now writes `Host crm114` + `Match User crm114 Host localhost` rules pointing to the generated key, then validates they exist in the completion summary so operators can immediately run `ssh crm114@localhost`.
7. ✅ Restore crm114 SSH reachability
   - Enforced crm114 ownership/permissions on `/Users/.crm114`, forced `AuthenticationMethods publickey`, and expanded completion summary rows so the generated key is verified locally and remotely before exiting.

## Won't Do
- _None_

## Gum Installer Flow (Hidden User + Key Provisioning)
1. **Bootstrap** – `gum style` banner summarizing hidden user/SSH goals, followed by `gum confirm` before any sudo escalation.
2. **Reinstall Detection** – `gum log` reports findings from `detect_existing_crm114_state`; when artifacts exist the script shows them via `gum style` and requires two confirmations (`Remove previous CRM114 installation?` and `This will delete hidden user data. Continue?`). On approval it runs `perform_reinstall_cleanup` (user deletion, hidden home removal, credential/libexec cleanup, sshd restore, local key/config wipe). Declines are logged as warnings before proceeding.
3. **Sudo Prep** – `gum log` explains why admin privileges are needed; script runs `sudo -v` with keepalive.
4. **Hidden Home + User** – `gum spin --title "Creating hidden user" -- bash -c 'create_hidden_home && ensure_hidden_user && enforce_hidden_user_properties'` so users see progress; ensure `/Users/.crm114` ends owned by `crm114:staff` (not root).
5. **Credential Store** – `gum spin` wraps random password generation stored at `/var/root/.crm114_credentials` and logged via `gum log --level info`.
6. **SSH Enablement** – `gum spin --title "Enabling Remote Login" -- systemsetup -setremotelogin on`; follow with `gum spin` around `dseditgroup` restriction.
7. **Keypair Generation (passwordless only)** – always generate a dedicated ed25519 key at `~/.ssh/crm114_ed25519` (regardless of prior keys) with `gum spin --title "Generating crm114 key"`. Display fingerprint via `gum log` and refuse password prompts entirely.
8. **Local SSH Config Automation** – `gum spin --title "Updating SSH config" -- bash -c 'install_local_ssh_rules'` appends both a `Host crm114` stanza and a `Match User crm114 Host localhost` block so any `ssh crm114@localhost` invocation automatically uses the dedicated key, disables strict host checks, and logs that the previous config was backed up.
9. **Authorized Keys Install** – `gum spin --title "Authorizing crm114 key" -- bash -c 'install_remote_authorized_key'` ensures `/Users/.crm114/.ssh` exists with correct perms and contains the freshly generated public key.
10. **Summary** – `gum table` displays rows for hidden user, credential store, Remote Login, local key, SSH config, and remote authorized key so operators can confirm every prerequisite is ✅ before exiting.

## Dependencies & Open Questions
- Requires Gum 0.13+ (script still download-if-missing) plus macOS sshd tooling (`systemsetup`, `dscl`, `dseditgroup`, `ssh-keygen`).
- Need detection for existing `/Users/.crm114` ownership issues; default flow now reassigns permissions unless user opts into full reinstall removal.
- Local SSH config rules must be written automatically for `ssh crm114@localhost`, preserving existing config via backup + idempotent insert (implemented via `install_local_ssh_rules`).
- Credential store stays fixed at `/var/root/.crm114_credentials`; no user override for consistency with uninstall detection.
- Existing installation detection currently covers hidden home, credential store, libexec dir, wish-login wrapper, sshd backups, and local SSH assets; revisit criteria once additional artifacts (Wish binary, launchd plists) exist.

## Debrief
- Reconciled installer requirements across research docs to isolate the hidden-user + key bootstrap slice and ensured scope excludes Wish/Homebrew work.
- Authored Gum-driven flow covering consent, reinstall detection/removal, sudo prep, hidden user creation, credential storage, Remote Login enablement, local key generation, SSH config automation, and authorized key installation, then implemented reinstall scanning/cleanup + forced passwordless key provisioning in install.sh.
- Documented dependencies plus new decisions: fixed credential store location, mandatory passwordless keys, automatic SSH config aliasing, and criteria prompting destructive reinstall confirmation.
